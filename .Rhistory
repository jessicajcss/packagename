source("./scripts/01-AQI_calculation_thermo_data.R")
source("./scripts/01-AQI_calculation_thermo_data.R")
source("./scripts/01-AQI_calculation_thermo_data.R")
View(dataaggfinal)
air_quality_data <- dataaggfinal %>%
select(Cidade, date, SO2, NO2, O3, CO, PM2.5, PM10) %>%
gather(key = variable, value = value, -c("Cidade", "date")) %>%
dplyr::mutate(variable = factor(variable,
levels=c('SO2', 'NO2', 'O3', 'CO',
'PM10', 'PM2.5'))) %>%
dplyr::group_by(Cidade, variable) %>%
dplyr::mutate(Npoints = 1:n() - findInterval(date - hours(w), date),
Mean8 = zoo::rollapply(value, Npoints, mean, partial = TRUE, fill = NA)) %>% #https://stackoverflow.com/questions/75686593/rolling-mean-of-time-series-with-missing-dates-in-r
dplyr::ungroup() %>%
dplyr::mutate(sample_day = as.Date(date, format = "%Y-%m-%d", , tz = "America/Sao_Paulo"),
Mean8 = case_when(Npoints < 8 | (variable != "O3" & variable != "CO") ~ NA, TRUE ~ Mean8)) %>%
dplyr::mutate(value = case_when(variable == "O3" ~ Mean8,
variable == "CO" ~ Mean8,
TRUE ~ value)) %>%
dplyr::select(-date, -Npoints, -Mean8) %>%
drop_na() %>%
dplyr::group_by(Cidade, sample_day, variable) %>%
dplyr::mutate(value = case_when(variable == "O3" ~ max(value),
variable == "CO" ~ max(value),
variable == "SO2" ~ max(value),
variable == "NO2" ~ max(value),
TRUE ~ mean(value, na.rm = T))) %>%
unique() %>%
dplyr::select(Cidade, variable, sample_day, value) %>%
tidyr::spread(key = variable, value = value) %>%
replace(is.na(.), -999) %>% #WORKING AROUND NA VALUES
dplyr::rowwise() %>%
dplyr::mutate(AQI_SO2 = aqiFromSO2(SO2),
AQI_NO2 = aqiFromNO2(NO2),
AQI_O3 = aqiFromO3(O3),
AQI_CO = aqiFromCO(CO),
AQI_PM25 = aqiFromPM25(PM2.5),
AQI_PM10 = aqiFromPM10(PM10))  %>%
replace(.< 0, NA) %>%
#mutate_if(function(x) all(x < 0), function(x) NA)  %>%
dplyr::mutate(AQI = pmax(AQI_SO2, AQI_NO2, AQI_O3, AQI_CO, AQI_PM25, AQI_PM10, na.rm = T),
AQI_Qualidade = AQI_Qualidade(AQI))
View(air_quality_data)
air_quality_data <- dataaggfinal %>%
select(Cidade, date, SO2, NO2, O3, CO, PM2.5, PM10) %>%
gather(key = variable, value = value, -c("Cidade", "date")) %>%
dplyr::mutate(variable = factor(variable,
levels=c('SO2', 'NO2', 'O3', 'CO',
'PM10', 'PM2.5'))) %>%
dplyr::group_by(Cidade, variable) %>%
dplyr::mutate(Npoints = 1:n() - findInterval(date - hours(w), date),
Mean8 = rollapplyr(value, Npoints, mean, partial = TRUE, fill = NA)) %>% #https://stackoverflow.com/questions/75686593/rolling-mean-of-time-series-with-missing-dates-in-r
dplyr::ungroup() %>%
dplyr::mutate(sample_day = as.Date(date, format = "%Y-%m-%d", , tz = "America/Sao_Paulo"),
Mean8 = case_when(Npoints < 8 | (variable != "O3" & variable != "CO") ~ NA, TRUE ~ Mean8)) %>%
dplyr::mutate(value = case_when(variable == "O3" ~ Mean8,
variable == "CO" ~ Mean8,
TRUE ~ value)) %>%
dplyr::select(-date, -Npoints, -Mean8) %>%
drop_na() %>%
dplyr::group_by(Cidade, sample_day, variable) %>%
dplyr::mutate(value = case_when(variable == "O3" ~ max(value),
variable == "CO" ~ max(value),
variable == "SO2" ~ max(value),
variable == "NO2" ~ max(value),
TRUE ~ mean(value, na.rm = T))) %>%
unique() %>%
dplyr::select(Cidade, variable, sample_day, value) %>%
tidyr::spread(key = variable, value = value) %>%
replace(is.na(.), -999) %>% #WORKING AROUND NA VALUES
dplyr::rowwise() %>%
dplyr::mutate(AQI_SO2 = aqiFromSO2(SO2),
AQI_NO2 = aqiFromNO2(NO2),
AQI_O3 = aqiFromO3(O3),
AQI_CO = aqiFromCO(CO),
AQI_PM25 = aqiFromPM25(PM2.5),
AQI_PM10 = aqiFromPM10(PM10))  %>%
replace(.< 0, NA) %>%
#mutate_if(function(x) all(x < 0), function(x) NA)  %>%
dplyr::mutate(AQI = pmax(AQI_SO2, AQI_NO2, AQI_O3, AQI_CO, AQI_PM25, AQI_PM10, na.rm = T),
AQI_Qualidade = AQI_Qualidade(AQI))
View(dataaggfinal)
View(data_thermo_agg)
source("./scripts/01-AQI_calculation_thermo_data.R")
source("./scripts/01-AQI_calculation_thermo_data.R")
air_quality_data <- dataaggfinal %>%
select(Cidade, date, SO2, NO2, O3, CO, PM2.5, PM10) %>%
gather(key = variable, value = value, -c("Cidade", "date")) %>%
dplyr::mutate(variable = factor(variable,
levels=c('SO2', 'NO2', 'O3', 'CO',
'PM10', 'PM2.5'))) %>%
dplyr::group_by(Cidade, variable) %>%
dplyr::mutate(Npoints = 1:n() - findInterval(date - hours(w), date),
Mean8 = zoo::rollapply(value, Npoints, mean, partial = TRUE, fill = NA)) %>% #https://stackoverflow.com/questions/75686593/rolling-mean-of-time-series-with-missing-dates-in-r
dplyr::ungroup() %>%
dplyr::mutate(sample_day = as.Date(date, format = "%Y-%m-%d", , tz = "America/Sao_Paulo"),
Mean8 = case_when(Npoints < 8 | (variable != "O3" & variable != "CO") ~ NA, TRUE ~ Mean8)) %>%
dplyr::mutate(value = case_when(variable == "O3" ~ Mean8,
variable == "CO" ~ Mean8,
TRUE ~ value)) %>%
dplyr::select(-date, -Npoints, -Mean8) %>%
drop_na() %>%
dplyr::group_by(Cidade, sample_day, variable) %>%
dplyr::mutate(value = case_when(variable == "O3" ~ max(value),
variable == "CO" ~ max(value),
variable == "SO2" ~ max(value),
variable == "NO2" ~ max(value),
TRUE ~ mean(value, na.rm = T))) %>%
unique() %>%
dplyr::select(Cidade, variable, sample_day, value) %>%
tidyr::spread(key = variable, value = value) %>%
replace(is.na(.), -999) %>% #WORKING AROUND NA VALUES
dplyr::rowwise() %>%
dplyr::mutate(AQI_SO2 = aqiFromSO2(SO2),
AQI_NO2 = aqiFromNO2(NO2),
AQI_O3 = aqiFromO3(O3),
AQI_CO = aqiFromCO(CO),
AQI_PM25 = aqiFromPM25(PM2.5),
AQI_PM10 = aqiFromPM10(PM10))  %>%
replace(.< 0, NA) %>%
#mutate_if(function(x) all(x < 0), function(x) NA)  %>%
dplyr::mutate(AQI = pmax(AQI_SO2, AQI_NO2, AQI_O3, AQI_CO, AQI_PM25, AQI_PM10, na.rm = T),
AQI_Qualidade = AQI_Qualidade(AQI))
source("./scripts/01-AQI_calculation_thermo_data.R")
